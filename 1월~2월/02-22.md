# ë©€í‹° ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ì—ì„œ Prometheus + Grafana ëª¨ë‹ˆí„°ë§ êµ¬ì¶•



[ë©€í‹°ë…¸ë“œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶•.](https://velog.io/@luckyprice1103/%EB%A9%80%ED%8B%B0%EB%85%B8%EB%93%9C-Kubernetes-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%B6%95)

âœ… ëª©í‘œ:

Prometheus + Grafanaë¥¼ Kubernetes í´ëŸ¬ìŠ¤í„°ì— ë°°í¬
í´ëŸ¬ìŠ¤í„°ì˜ CPU, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ëª¨ë‹ˆí„°ë§í•˜ê³  ì‹œê°í™”
Helmì„ ì‚¬ìš©í•˜ì—¬ ê°„í¸í•˜ê²Œ ì„¤ì¹˜

âœ… êµ¬ì„± ìš”ì†Œ:

Prometheus: Kubernetesì˜ ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
Grafana: Prometheusì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„°ë¥¼ ì‹œê°í™”í•˜ëŠ” ëŒ€ì‹œë³´ë“œ


## 1. Helm ì„¤ì¹˜ (Helm íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì‚¬ìš©)
ğŸ”¹ Helmì´ë€?

Kubernetesì—ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ê°„í¸í•˜ê²Œ ì„¤ì¹˜í•  ìˆ˜ ìˆëŠ” íŒ¨í‚¤ì§€ ê´€ë¦¬ ë„êµ¬
Prometheus + Grafanaë¥¼ Helm Chartë¡œ ì‰½ê²Œ ì„¤ì¹˜í•  ìˆ˜ ìˆìŒ

ğŸ”¹ Helm ì„¤ì¹˜:
Control Planeì—ì„œ ì‹¤í–‰
``` bash
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

helm version

```



## 2. Prometheus + Grafanaë¥¼ Helmìœ¼ë¡œ ì„¤ì¹˜
ğŸ”¹ Helmì„ ì‚¬ìš©í•˜ì—¬ Prometheus & Grafana Chart ì €ì¥ì†Œ ì¶”ê°€
```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
```
âœ” prometheus-communityë¼ëŠ” Helm Chart ì €ì¥ì†Œê°€ ì¶”ê°€ë¨


ğŸ”¹ Prometheus + Grafana ë°°í¬
```bash
helm install monitoring prometheus-community/kube-prometheus-stack --namespace monitoring --create-namespace

```
![](https://velog.velcdn.com/images/luckyprice1103/post/f776fae3-296c-4a6f-830d-93aaeae2c2c5/image.png)


âœ… ì´ ëª…ë ¹ì–´ê°€ í•˜ëŠ” ì¼:

Prometheus + Grafanaë¥¼ monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë°°í¬
kube-prometheus-stack Chartë¥¼ ì‚¬ìš©í•˜ì—¬ Kubernetes í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§


âœ” ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸:

``` bash
kubectl get pods -n monitoring

```
![](https://velog.velcdn.com/images/luckyprice1103/post/eb474ffa-af35-426f-ae7b-a1b815077a6f/image.png)
âœ… Running ìƒíƒœë©´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ëœ ê²ƒ! ğŸ‰


## 3. Grafanaì— ì ‘ì†í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§

### 1. í¬íŠ¸ 3000 ì›¹ ì ‘ì†
ğŸ”¹ Grafanaë¥¼ í¬íŠ¸ í¬ì›Œë”©í•˜ì—¬ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
``` bash
kubectl port-forward svc/monitoring-grafana 3000:80 -n monitoring
```
âœ… í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì˜ Grafana(í¬íŠ¸ 80)ë¥¼ ë¡œì»¬ ì»´í“¨í„°ì˜ localhost:3000ì—ì„œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ í¬íŠ¸ í¬ì›Œë”©í•˜ëŠ” ì—­í• ì„ í•¨.



âœ… ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì† ì‹œë„:

![](https://velog.velcdn.com/images/luckyprice1103/post/e83ab11f-7ae6-4686-99d3-d0d380eba1f4/image.png)
ğŸ”¹ ì—°ê²° ì‹¤íŒ¨.

kubectl port-forwardëŠ” ë¡œì»¬ ë¨¸ì‹ ì—ì„œë§Œ ì ‘ì† ê°€ëŠ¥. kubectl port-forwardëŠ” ì˜¤ì§ localhost(127.0.0.1)ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥!
ì¦‰, í¼ë¸”ë¦­ IP(ì˜ˆ: 3.39.236.1:3000 ë¡œëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ!)

ğŸ’¡ í•´ê²° ë°©ë²•:

SSH í„°ë„ë§ì„ ì´ìš©í•´ì„œ ë¡œì»¬ì—ì„œ ì ‘ì†í•˜ê¸°

=================ë‚´ ë¡œì»¬ ì»´í“¨í„°=======================
``` bash
ssh -L 3000:localhost:3000 -N -f -i kakao_key.pem ubuntu@ec2-3-39-236-1.ap-northeast-2.compute.amazonaws.com
```
![](https://velog.velcdn.com/images/luckyprice1103/post/80f57b13-3302-458f-89c8-7a6d8958122d/image.png)


ğŸ”¹ë‹¤ì‹œ ì ‘ì† ì‹œë„. (ë‚´ ë¡œì»¬ ì»´í“¨í„°ì˜ localhost:3000)
âœ… ì´ì œ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì† ì„±ê³µ:

![](https://velog.velcdn.com/images/luckyprice1103/post/fc878426-c502-416b-a686-3a7b3177dd85/image.png)

ğŸ”¹ Grafana ê¸°ë³¸ ë¡œê·¸ì¸ ì •ë³´:

Username: admin
Password: prom-operator (ê¸°ë³¸ê°’)


### 2. í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸

âœ” ë¡œê·¸ì¸ í›„ "Add Data Source" â†’ "Prometheus" ì„ íƒ
âœ” Prometheus ì£¼ì†Œë¥¼ http://monitoring-prometheus-kube-prometheus:9090ë¡œ ì„¤ì •
![](https://velog.velcdn.com/images/luckyprice1103/post/da0fddb8-8d9d-4c3f-a7a3-e4229a18b7ba/image.png)


1ï¸âƒ£ Grafana ì™¼ìª½ ë©”ë‰´ì—ì„œ ğŸ“Š Dashboards â†’ Import í´ë¦­
2ï¸âƒ£ ê³µì‹ Kubernetes ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ID ì…ë ¥

ëŒ€ì‹œë³´ë“œ ID: 315 (Kubernetes í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§)
ë˜ëŠ” 1860 (Kubernetes Node Exporter)
3ï¸âƒ£ "Load" ë²„íŠ¼ í´ë¦­
4ï¸âƒ£ "Prometheus" ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ
5ï¸âƒ£ "Import" ë²„íŠ¼ í´ë¦­
âœ… ì´ì œ Kubernetes í´ëŸ¬ìŠ¤í„°ì˜ ì „ì²´ì ì¸ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥...! ğŸ‰

![](https://velog.velcdn.com/images/luckyprice1103/post/b46f656a-8312-4317-b5c1-c1175311f171/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/7e2f64dd-580e-4787-bd38-2a85d93b896c/image.png)


## 4. í´ëŸ¬ìŠ¤í„° ë¶€í•˜ í…ŒìŠ¤íŠ¸

### 1. BusyBoxë¥¼ ì‚¬ìš©í•˜ì—¬ CPU ë¶€í•˜ ë°œìƒ
ğŸ“Œ Control Planeì—ì„œ ì‹¤í–‰:
```bash
kubectl run cpu-stress --image=busybox --restart=Never -- /bin/sh -c "while true; do echo 'stressing CPU'; done"

```
âœ… ì´ PodëŠ” ì¢…ë£Œë˜ì§€ ì•Šê³  ê³„ì†í•´ì„œ CPU ë¶€í•˜ë¥¼ ë°œìƒì‹œí‚´.

ğŸ”¹ ì‹¤í–‰ëœ Pod í™•ì¸:

```
kubectl get pods
```
ğŸ”¹ íŠ¹ì • Podì˜ ë¡œê·¸ í™•ì¸ (CPU ë¶€í•˜ê°€ ì§€ì†ì ìœ¼ë¡œ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸)

```
kubectl logs cpu-stress
```
âœ” CPU ë¶€í•˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ë ¤ë©´ Prometheus + Grafana ëŒ€ì‹œë³´ë“œë¥¼ í™•ì¸!
![](https://velog.velcdn.com/images/luckyprice1103/post/e37fc02a-95a8-43a5-be94-8e74e7d2a605/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/0f4f2fb0-e0d8-45a0-a3c8-82059e2f36d7/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/859509ca-7634-4fd5-886a-b7752a34f87a/image.png)

âœ… ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì¢…ë£Œ:

```
kubectl delete pod cpu-stress
```


### 2. ë©€í‹°ë…¸ë“œì—ì„œ HTTP ë¶€í•˜ í…ŒìŠ¤íŠ¸ (k6 ì‚¬ìš©)
âœ… ëª©í‘œ:

ì—¬ëŸ¬ Worker ë…¸ë“œì—ì„œ HTTP ìš”ì²­ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ì—¬ ì‹¤ì œ íŠ¸ë˜í”½ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì§„í–‰
k6ëŠ” Kubernetesì—ì„œ ì—¬ëŸ¬ Podë¡œ ë°°í¬ ê°€ëŠ¥í•˜ì—¬ ë©€í‹°ë…¸ë“œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

âœ” 1) k6 ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  Deployment ìƒì„±

- k6-deployment.yaml
```bash
apiVersion: apps/v1
kind: Deployment
metadata:
  name: k6-load-test
spec:
  replicas: 3  # ì—¬ëŸ¬ Worker ë…¸ë“œì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
  selector:
    matchLabels:
      app: k6
  template:
    metadata:
      labels:
        app: k6
    spec:
      containers:
      - name: k6
        image: grafana/k6
        args: ["run", "-u", "50", "-d", "60s", "https://nginx:80"]

```

ğŸ“Œ ì ìš©:


```bash
kubectl apply -f k6-deployment.yam
```

âœ… ì„¤ëª…:

replicas: 3 â†’ 3ê°œì˜ Podê°€ ì—¬ëŸ¬ Worker ë…¸ë“œì—ì„œ ë°°í¬ë˜ë©° HTTP ë¶€í•˜ë¥¼ ë¶„ì‚° ìƒì„±
-u 50 â†’ ë™ì‹œ 50ëª…ì˜ ì‚¬ìš©ì(virtual users) ìƒì„±
-d 60s â†’ 60ì´ˆ ë™ì•ˆ HTTP ìš”ì²­ì„ ì§€ì†ì ìœ¼ë¡œ ìˆ˜í–‰

![](https://velog.velcdn.com/images/luckyprice1103/post/52e71d70-4369-45e0-b6a1-7ecc363a56ec/image.png)


![](https://velog.velcdn.com/images/luckyprice1103/post/98691c5e-bc23-4705-89db-2f3c9c89f58d/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/7646d1eb-2b3f-47c2-b05b-3f3d8241eeb1/image.png)


kubectl delete deployment k6-load-test

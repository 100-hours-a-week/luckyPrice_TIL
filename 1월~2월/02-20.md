#  ë©€í‹°ë…¸ë“œ Kubernetes í´ëŸ¬ìŠ¤í„° êµ¬ì¶•



![](https://velog.velcdn.com/images/luckyprice1103/post/b31cd8a4-f97a-46b1-8357-64ee6b896080/image.png)




## 1. ë…¸ë“œ ìƒì„±.
### 1. ec2 í…œí”Œë¦¿ ìƒì„±

ì›ë˜ëŠ” ec2ì— ì¿ ë²„ë„¤í‹°ìŠ¤, ë„ì»¤ ê´€ë ¨ ì„¤ì¹˜ë¥¼ ê°ê° í•´ì•¼í•˜ì§€ë§Œ, í…œí”Œë¦¿ì„ ì´ìš©í•˜ì—¬ ê°„ì†Œí™” í•´ë³´ë„ë¡ í•¨.

![](https://velog.velcdn.com/images/luckyprice1103/post/90cac7cf-8b0d-44d9-af42-cc8be23f1825/image.png)

ìš´ì˜ì²´ì œ -> ubuntu 22.04
ì¸ìŠ¤í„´ìŠ¤ ìœ í˜• -> t3.medium
ìŠ¤í† ë¦¬ì§€ -> ebs gp2, 30gb


ì‚¬ìš©ì ë°ì´í„°ì— ì„¤ì • íŒŒì¼ ì…ë ¥.
![](https://velog.velcdn.com/images/luckyprice1103/post/cafa321e-11d3-417c-874b-ad4ad36d0c48/image.png)

```bash
#!/bin/bash
set -eux  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¤‘ë‹¨ & ë””ë²„ê¹…ìš© ì¶œë ¥ í™œì„±í™”

# âœ… íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
sudo apt-get update -y

# âœ… Swap ë¹„í™œì„±í™” (ì¬ë¶€íŒ… í›„ì—ë„ ìœ ì§€)
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# âœ… Swap ë©”ëª¨ë¦¬ ë¹„í™œì„±í™” í™•ì¸
free -h

# âœ… í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
sudo apt-get install -y ca-certificates curl apt-transport-https gpg

# âœ… Docker GPG í‚¤ ì¶”ê°€
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# âœ… Docker ì €ì¥ì†Œ ì¶”ê°€ ë° ì„¤ì¹˜
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl enable --now docker


# âœ… Containerd ê´€ë ¨ ëª¨ë“ˆ ì„¤ì • (ì¬ë¶€íŒ… í›„ì—ë„ ìœ ì§€ë¨)
cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

# âœ… Containerd ë„¤íŠ¸ì›Œí¬ ì„¤ì • (Kubernetesì™€ í˜¸í™˜ë˜ë„ë¡ ìˆ˜ì •)
sudo modprobe overlay
sudo modprobe br_netfilter
cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables=1
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-ip6tables=1
EOF
sudo sysctl --system

# âœ… containerd ì„¤ì • íŒŒì¼ ìˆ˜ì •
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

# âœ… Kubernetes GPG í‚¤ ì¶”ê°€
sudo curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# âœ… Kubernetes ì €ì¥ì†Œ ì¶”ê°€
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

# âœ… Kubernetes ì„¤ì¹˜ (kubeadm, kubelet, kubectl)
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl  # ë²„ì „ ê³ ì •

# âœ… ì„¤ì¹˜ ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥
echo " Kubernetes & Docker launch complete now you can use them
```


ìƒì„± ì™„ë£Œ....!
![](https://velog.velcdn.com/images/luckyprice1103/post/240f18e7-4c60-4302-99b8-c6011708f3ac/image.png)




### 2. hostnameë³€ê²½
sudo su
sudo hostnamectl set-hostname kcontrolplane
sudo hostnamectl set-hostname worker01
sudo hostnamectl set-hostname worker02

### 3. ì„¤ì¹˜ í™•ì¸.

sudo kubeadm init
#ëª¨ë“  terminal windowë§ˆë‹¤í•´ì•¼í•¨
export KUBECONFIG=/etc/kubernetes/admin.conf

ğŸ’¡ ë§Œì•½ permission denied ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´, ì•„ë˜ ê¶Œí•œ ë³€ê²½ ì¶”ê°€
sudo chown $(id -u):$(id -g) /etc/kubernetes/admin.conf


- kcontrolplane
![](https://velog.velcdn.com/images/luckyprice1103/post/0fbec979-25dd-46fd-8354-374830556e61/image.png)


- worker node01
![](https://velog.velcdn.com/images/luckyprice1103/post/7dd056d8-a8c6-426d-8675-605ec99e399f/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/c04fdfd6-ee6f-4318-a6f1-1682a0d1af2a/image.png)



- worker node02
![](https://velog.velcdn.com/images/luckyprice1103/post/b8c74097-4f78-43cf-8921-eac5bc7d9a76/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/77b5d79f-f2d5-49f6-9a3d-f7c5ec3cb16e/image.png)

ğŸš€ Worker ë…¸ë“œì—ì„œ kubectl version ì‹¤í–‰ ì‹œ "The connection to the server localhost:8080 was refused" ì˜¤ë¥˜ -> ì •ìƒ

Worker ë…¸ë“œì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ kubectlì„ ì‹¤í–‰í•´ë„ Kubernetes API ì„œë²„(6443 í¬íŠ¸)ì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸.

Worker ë…¸ë“œì—ëŠ” Kubernetes Control Plane(API Server, etcd ë“±)ì´ ì—†ìŒ ê¸°ë³¸ì ìœ¼ë¡œ kubectlì€ localhost:8080ì„ API ì„œë²„ë¡œ ì¸ì‹í•˜ì§€ë§Œ, Worker ë…¸ë“œì—ëŠ” API ì„œë²„ê°€ ì—†ì–´ì„œ ì—°ê²°ì´ ì‹¤íŒ¨ Worker ë…¸ë“œì—ì„œ kubectlì„ ì‹¤í–‰í•˜ë ¤ë©´ Control Planeì˜ kubeconfig íŒŒì¼ì„ ë³µì‚¬í•´ì•¼ í•¨

## 2. worker ë…¸ë“œë¥¼ Control Planeì— ì¶”ê°€.


kcontrolplaneì—ì„œ join message ë³µì‚¬ í•´ì„œ workerë¡œ

==========worker =================================

sudoÂ kubeadm join 192.168.35.50:6443 --token hm6os1.qoi3qn1hecpqx6pl --discovery-token-ca-cert-hash sha256:efe798a7234e5e3b6
![](https://velog.velcdn.com/images/luckyprice1103/post/3d2c1bd2-d4d7-49a3-bda7-938d9f3580b1/image.png)

- ì—ëŸ¬
![](https://velog.velcdn.com/images/luckyprice1103/post/ed3f5795-62ee-4edc-9f38-fd6fc3330676/image.png)


AWS ë³´ì•ˆ ê·¸ë£¹ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìê¸° ìì‹ (SG ë‚´ë¶€ í†µì‹ )ì„ ìë™ìœ¼ë¡œ í—ˆìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í—ˆìš©í•´ì¤˜ì•¼í•¨.

![](https://velog.velcdn.com/images/luckyprice1103/post/7091d5d6-431f-46d0-b033-584186db1fca/image.png)

- ì„±ê³µ.
![](https://velog.velcdn.com/images/luckyprice1103/post/a8bc3760-5e3b-4e83-bfb0-f4cc8565a494/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/5017fd06-9c96-4fc7-b062-ecf126641508/image.png)

 ì´ì œ Worker01, Worker02 ë…¸ë“œê°€ ì •ìƒì ìœ¼ë¡œ Control Planeì— í•©ë¥˜ë¨
 
 ![](https://velog.velcdn.com/images/luckyprice1103/post/90e74db2-2281-4217-9ea9-71beb23e69a5/image.png)


## 3. network ì„¤ì¹˜

 ì´ ë‹¨ê³„ì—ì„œëŠ” Kubernetes ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ì ìš©í•˜ê³ , kubectlì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ ì ê²€.

==========master =================================

### 1. ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸(Calico) ì ìš©
#user
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

![](https://velog.velcdn.com/images/luckyprice1103/post/e02f7074-9e42-44fd-b59b-78b6cd39875b/image.png)
âœ… ì´ ì½”ë“œê°€ í•˜ëŠ” ì¼:

Control Planeì—ì„œ ê´€ë¦¬ì(Admin) ê¶Œí•œìœ¼ë¡œ kubectlì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ Kubeconfig ì„¤ì •ì„ ë³µì‚¬í•˜ëŠ” ê³¼ì •
/etc/kubernetes/admin.conf íŒŒì¼ì„ í˜„ì¬ ì‚¬ìš©ì($HOME/.kube/config)ë¡œ ë³µì‚¬
kubectlì´ ì´ ì„¤ì •ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ì„œ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •



#root


```bash
export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl apply -f https://docs.projectcalico.org/v3.25/manifests/calico.yaml
```

![](https://velog.velcdn.com/images/luckyprice1103/post/e5843cbf-189c-46c0-aff2-9e38ea6f50f5/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/a010ef8e-5ede-44bf-946d-76a5ed4fae59/image.png)

âœ… ì´ ì½”ë“œê°€ í•˜ëŠ” ì¼:

kubectlì´ ê¸°ë³¸ì ìœ¼ë¡œ /etc/kubernetes/admin.confë¥¼ ì‚¬ìš©í•˜ë„ë¡ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
í˜„ì¬ í„°ë¯¸ë„ ì„¸ì…˜ì—ì„œë§Œ ì ìš©ë¨ (í„°ë¯¸ë„ì„ ë‹«ìœ¼ë©´ ì„¤ì •ì´ ì‚¬ë¼ì§)
ğŸ’¡ ì´ ì„¤ì •ì´ ì—†ìœ¼ë©´?

kubectlì„ ì‹¤í–‰í•˜ë©´ Kubernetes API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ì„œ kubectl get nodes ê°™ì€ ëª…ë ¹ì–´ê°€ ë™ì‘í•˜ì§€ ì•ŠìŒ

## í´ëŸ¬ìŠ¤í„° ë™ì‘ í™•ì¸


```bash
kubectl get pods -A
```
![](https://velog.velcdn.com/images/luckyprice1103/post/91dc17fc-772a-44bb-aa92-9af28d7442a8/image.png)

âœ” ëª¨ë“  ì‹œìŠ¤í…œ ê´€ë ¨ Podê°€ Running ìƒíƒœì¸ì§€ í™•ì¸
âœ” íŠ¹íˆ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆëŠ” calico, kube-proxyê°€ ì •ìƒ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸


```bash
kubectl get nodes
```

![](https://velog.velcdn.com/images/luckyprice1103/post/f90d4ecc-7dbf-423e-a36a-36f8c3edf4b3/image.png)

âœ” ëª¨ë“  ë…¸ë“œê°€ Ready ìƒíƒœë¼ë©´ í´ëŸ¬ìŠ¤í„° ì •ìƒ ì‘ë™ ğŸ‰(NotReady->Ready)
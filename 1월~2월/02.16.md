## âœ… ë‹¨ê³„ 1: Docker Private Registry ê¸°ë³¸ êµ¬ì¶•
â€¢ registry:2 ê³µì‹ ì´ë¯¸ì§€ë¥¼ í™œìš©í•˜ì—¬ ë¡œì»¬ Private Registry ì»¨í…Œì´ë„ˆ ì‹¤í–‰
â€¢ docker tag ë° docker push ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ Private Registryì— ì—…ë¡œë“œ
â€¢ docker pullì„ í†µí•´ ì €ì¥ëœ ì´ë¯¸ì§€ ì •ìƒ ë‹¤ìš´ë¡œë“œ í™•ì¸

### 1. ë¡œì»¬ Private Registry ì»¨í…Œì´ë„ˆ ì‹¤í–‰
Dockerì—ì„œ ì œê³µí•˜ëŠ” registry:2 ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ Private Registry ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰.

```bash
docker run -d --name registry -p 5000:5000 --restart=always registry:2
```

-d: ì»¨í…Œì´ë„ˆë¥¼ ë°±ê·¸ë¼ìš´ë“œ ëª¨ë“œë¡œ ì‹¤í–‰.
-p 5000:5000: í˜¸ìŠ¤íŠ¸ì˜ 5000 í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆì˜ 5000 í¬íŠ¸ì— ë§¤í•‘í•˜ì—¬ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•¨.
--name registry: ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ registryë¡œ ì§€ì •.

5000 í¬íŠ¸ listen ìœ ë¬´ í™•ì¸.
![](https://velog.velcdn.com/images/luckyprice1103/post/be13fd64-88bb-49c3-aa5d-ba9f51da7b08/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/160df6e9-241c-4f71-adfd-8cc5901142a5/image.png)

### 2. ì´ë¯¸ì§€ë¥¼ Private Registryì— ì—…ë¡œë“œí•˜ê¸° ìœ„í•œ íƒœê¹…
ë¡œì»¬ì— ìˆëŠ” ì´ë¯¸ì§€ë¥¼ Private Registryì— ì—…ë¡œë“œí•˜ê¸° ì „ì—, ì´ë¯¸ì§€ì— ìƒˆë¡œìš´ íƒœê·¸ë¥¼ ë¶™ì—¬ì„œ Registry ì£¼ì†Œë¥¼ í¬í•¨ì‹œì¼œì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë¡œì»¬ì— my-app:latestë¼ëŠ” ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ íƒœê¹…:
```bash
docker tag hello-world:latest [registryê°€ ìœ„ì¹˜í•œ ë¨¸ì‹ ì˜ ì£¼ì†Œ:5000]/hello-world:latest

```
![](https://velog.velcdn.com/images/luckyprice1103/post/e7f47fe7-c0f0-4802-a8c3-9c460f4a5b33/image.png)

### 3. ì´ë¯¸ì§€ ì—…ë¡œë“œ

```bash
docker push [registryê°€ ìœ„ì¹˜í•œ ë¨¸ì‹ ì˜ ì£¼ì†Œ:5000]/hello-world:latest

```


- ì—ëŸ¬ ë°œìƒ.
```
Get "https://192.168.0.31:5000/v2/": http: server gave HTTP response to HTTPS client
```

ì´ ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” Docker í´ë¼ì´ì–¸íŠ¸ê°€ ê¸°ë³¸ì ìœ¼ë¡œ HTTPSë¥¼ ì‚¬ìš©í•˜ì—¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì ‘ê·¼í•˜ë ¤ê³  í•˜ëŠ”ë°,
ì‹¤ì œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì„œë²„ëŠ” HTTPSê°€ ì•„ë‹Œ HTTPë¡œ ë™ì‘í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ë°œìƒ.

- í•´ê²°ë°©ë²•.
Insecure Registry ì„¤ì • ì‚¬ìš©
ë§Œì•½ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ HTTPSë¡œ êµ¬ì„±í•˜ì§€ ì•Šì•˜ë‹¤ë©´, Docker ë°ëª¬ì— í•´ë‹¹ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ "insecure registry"ë¡œ ì„¤ì •.

Linuxì˜ ê²½ìš°: /etc/docker/daemon.json íŒŒì¼ì— ë‹¤ìŒ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
```
{
  "insecure-registries": ["192.168.0.31:5000"]
}

```
systemctl restart docker


- push
```bash
docker push [registryê°€ ìœ„ì¹˜í•œ ë¨¸ì‹ ì˜ ì£¼ì†Œ:5000]/hello-world:latest

```

![](https://velog.velcdn.com/images/luckyprice1103/post/08bb128a-b772-458b-914d-c0920d02122d/image.png)


### 4. ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (Pull)ë¡œ ì •ìƒ ì €ì¥ í™•ì¸
ë§ˆì§€ë§‰ìœ¼ë¡œ, Private Registryì— ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ë‹¤ë¥¸ ì‹œìŠ¤í…œì´ë‚˜ ë™ì¼ ì‹œìŠ¤í…œì—ì„œ ì´ë¯¸ì§€ë¥¼ ë‚´ë ¤ë°›ìŒ.

![](https://velog.velcdn.com/images/luckyprice1103/post/a5f550a5-8832-49f9-8519-2261eebe9b4c/image.png)

## âœ… ë‹¨ê³„ 2: Registry ë³´ì•ˆ ì„¤ì • (TLS/SSL ì¸ì¦ ì ìš©)
â€¢ OpenSSLì„ ì‚¬ìš©í•˜ì—¬ ìì²´ ì„œëª…ëœ SSL ì¸ì¦ì„œ ìƒì„±
â€¢ ìƒì„±í•œ ì¸ì¦ì„œë¥¼ Registryì— ì ìš©í•˜ì—¬ HTTPS ê¸°ë°˜ í†µì‹  êµ¬ì„±
â€¢ curlì„ í™œìš©í•˜ì—¬ TLS ì ìš© ì—¬ë¶€ í™•ì¸


### *ë³¼ë¥¨ì„ ì‚¬ìš©í•˜ì—¬ Registry ë°ì´í„°ë¥¼ ì˜ì†ì ìœ¼ë¡œ ì €ì¥

```bash
docker run -d --name registry -p 5000:5000 --restart=always --mount type=volume,source=my-volume,target=/var/lib/registry registry:2
```
ì´ì œ ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí–ˆë‹¤ê°€ ì‹¤í–‰í•´ë„ ë‚´ìš©ì´ ë°ì´í„°ê°€ ë‚ ì•„ê°€ì§€ ì•ŠìŒ.

### 1. OpenSSLì„ ì‚¬ìš©í•˜ì—¬ ìì²´ ì„œëª…ëœ SSL ì¸ì¦ì„œ ìƒì„±

```bash
openssl req \
  -newkey rsa:4096 -nodes -sha256 \
  -keyout private_registry.key \
  -x509 -days 365 \
  -out private_registry.crt
```

- newkey rsa:4096: 4096ë¹„íŠ¸ RSA í‚¤ ìŒì„ ìƒì„±í•©ë‹ˆë‹¤.
- nodes: ê°œì¸í‚¤ë¥¼ ì•”í˜¸ ì—†ì´ ìƒì„±í•©ë‹ˆë‹¤.
- sha256: SHA-256 í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- x509: X.509 ì¸ì¦ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
- days 365: ì¸ì¦ì„œ ìœ íš¨ ê¸°ê°„ì„ 365ì¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.


![](https://velog.velcdn.com/images/luckyprice1103/post/dca8f357-c65b-4d0b-9bf7-87cd56908f84/image.png)


### 2. ìƒì„±í•œ ì¸ì¦ì„œë¥¼ Registryì— ì ìš©í•˜ì—¬ HTTPS ê¸°ë°˜ í†µì‹  êµ¬ì„±

```bash
docker run -d --name registry -p 5000:5000 \
--restart=always \
--mount type=volume,source=my-volume,target=/var/lib/registry \
-v /home/evan/cert:/certs \
-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/private_registry.crt \
-e REGISTRY_HTTP_TLS_KEY=/certs/private_registry.key \
registry:2
```
![](https://velog.velcdn.com/images/luckyprice1103/post/a952ea95-a63a-4e18-81ea-72b09b1ff9bf/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/9ffa886f-b777-4d89-86a7-083435c9804a/image.png)

### 3. curlì„ í™œìš©í•˜ì—¬ TLS ì ìš© ì—¬ë¶€ í™•ì¸

```bash
curl -v https://192.168.0.31:5000/v2/

```
![](https://velog.velcdn.com/images/luckyprice1103/post/7570f0b7-a9da-4e71-91b8-1458b5f753a5/image.png)

- pull
![](https://velog.velcdn.com/images/luckyprice1103/post/6b7e145c-154a-41ca-95f6-f912e3ec5c27/image.png)

ì´ì™€ ê°™ì´ OpenSSLì„ ì´ìš©í•œ ì¸ì¦ì„œ ìƒì„±, Registryì— ì¸ì¦ì„œ ì ìš©, ê·¸ë¦¬ê³  curlì„ í†µí•œ í™•ì¸ ê³¼ì •ì„ í†µí•´ Docker Registryì˜ ë³´ì•ˆì„ ê°•í™”í•  ìˆ˜ ìˆìŒ.

## âœ… ë‹¨ê³„ 3: ê¸°ë³¸ ì¸ì¦(Basic Authentication) ì„¤ì •
â€¢ htpasswdë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ê³„ì •ì„ ìƒì„±í•˜ê³  ì¸ì¦ ì ìš©
â€¢ docker login ëª…ë ¹ì–´ë¥¼ í™œìš©í•˜ì—¬ ì¸ì¦ í™•ì¸
â€¢ ì¸ì¦ ì—†ì´ ì ‘ê·¼ ì‹œ ì°¨ë‹¨ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸

### 1. htpasswdë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ê³„ì • ìƒì„±
- htpasswdë€?
Apache HTTP Serverì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¸ì¦ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ë„êµ¬ë¡œ, Docker Registryì—ë„ ê¸°ë³¸ ì¸ì¦ì„ ì ìš©í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

- ê³„ì • ìƒì„±
```bash
mkdir auth
docker run --entrypoint htpasswd httpd:2 -Bbn evan evan > auth/htpasswd
```

-B ì˜µì…˜ì€ bcrypt ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”.
-bn ì˜µì…˜ì€ ë°°ì¹˜ ëª¨ë“œë¡œ, í”„ë¡¬í”„íŠ¸ ì—†ì´ usernameê³¼ passwordë¥¼ ë°”ë¡œ ë°›ì•„ ì²˜ë¦¬.
ê²°ê³¼ë¡œ ìƒì„±ëœ auth/htpasswd íŒŒì¼ì— ì¸ì¦ ì •ë³´ê°€ ì €ì¥.
![](https://velog.velcdn.com/images/luckyprice1103/post/c2bd1c00-989f-4056-8d55-845d2b5adaf1/image.png)

ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆê°€ ë³´ì´ì§€ ì•ŠëŠ” ì´ìœ ëŠ” ì´ ëª…ë ¹ì–´ëŠ” ë‹¨ìˆœíˆ htpasswd ë„êµ¬ë¥¼ ì‹¤í–‰í•˜ì—¬ ì¸ì¦ íŒŒì¼ì„ ìƒì„±í•˜ê¸° ìœ„í•´ ì»¨í…Œì´ë„ˆë¥¼ ì¼íšŒì„±ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒ.

ì¼íšŒì„± ì‹¤í–‰:
docker run ëª…ë ¹ì–´ëŠ” ì§€ì •ëœ ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•œ í›„ ì¢…ë£Œ. htpasswd ëª…ë ¹ì–´ê°€ ì‹¤í–‰ë˜ì–´ ì¸ì¦ ì •ë³´ë¥¼ ì¶œë ¥í•˜ë©´, ê·¸ ê²°ê³¼ë¥¼ auth/htpasswd íŒŒì¼ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ì—¬ ì €ì¥í•œ í›„ ì»¨í…Œì´ë„ˆëŠ” ì¢…ë£Œë¨.

ì»¨í…Œì´ë„ˆê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹˜:
ì´ ê²½ìš°ì—ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ëŠ” ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆë¼, ë‹¨ìˆœíˆ í•„ìš”í•œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ë„êµ¬ë¡œ ì‚¬ìš©ë˜ì—ˆìœ¼ë¯€ë¡œ, ì‹¤í–‰ í›„ ì¢…ë£Œë˜ëŠ” ê²ƒì´ ì •ìƒ.


### 2. Registryì— ê¸°ë³¸ ì¸ì¦ ì ìš© (TLS/SSL ì¸ì¦ê³¼ ë³„ê°œë¡œ ì ìš©)

```bash
docker run -d --name registry -p 5000:5000 \
--restart=always \
--mount type=volume,source=my-volume,target=/var/lib/registry \
-v /home/evan/cert:/certs \
-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/private_registry.crt \
-e REGISTRY_HTTP_TLS_KEY=/certs/private_registry.key \
-v $(pwd)/auth:/auth \
-e "REGISTRY_AUTH=htpasswd" \
-e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
-e "REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd" \
registry:2
```

 - -v $(pwd)/auth:/auth: í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ auth í´ë”ë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ /authë¡œ ë§ˆìš´íŠ¸í•©ë‹ˆë‹¤.
- REGISTRY_AUTH=htpasswd: ê¸°ë³¸ ì¸ì¦ ì‚¬ìš©ì„ ì§€ì •.
- REGISTRY_AUTH_HTPASSWD_REALM: ì¸ì¦ ì˜ì—­(Realm)ì„ ì„¤ì •í•©ë‹ˆë‹¤. í´ë¼ì´ì–¸íŠ¸ì— ì¸ì¦ ì°½ì´ í‘œì‹œë  ë•Œ ì´ ì´ë¦„ì´ ë³´ì—¬ì§.
- REGISTRY_AUTH_HTPASSWD_PATH: ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì¸ì¦ íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì§€ì •.

### 3. docker login ëª…ë ¹ì–´ë¥¼ í™œìš©í•˜ì—¬ ì¸ì¦ í™•ì¸

- ì¸ì¦ í•˜ê¸°ì „.
![](https://velog.velcdn.com/images/luckyprice1103/post/ee213755-d5f5-4114-9b84-ce33172a9dee/image.png)

- ì •ìƒ ì¸ì¦ í™•ì¸
ì•„ë˜ì™€ ê°™ì´ docker login ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ Registryì— ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

``` bash
docker login 192.168.0.31:5000
```
ì‚¬ìš©ìëª…,ë¥¼ ì…ë ¥. ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ Login Succeeded ë©”ì‹œì§€ê°€ ì¶œë ¥ë¨.

![](https://velog.velcdn.com/images/luckyprice1103/post/0c21efb9-b1b9-40b1-9796-b198e74730fd/image.png)
- pull ì„±ê³µ.
![](https://velog.velcdn.com/images/luckyprice1103/post/65a3de0a-13a3-43a3-9848-7dd9d2e39a88/image.png)

## âœ… ë‹¨ê³„ 4: Docker ì´ë¯¸ì§€ ì„œëª… ë° ë¬´ê²°ì„± ê²€ì¦
â€¢ Docker Content Trust (DCT) í™œì„±í™” ë° ì„œëª…ëœ ì´ë¯¸ì§€ í‘¸ì‹œ
â€¢ ì„œëª…ë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œë„ ë° ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸

Docker Content Trust(DCT)ëŠ” Docker ì´ë¯¸ì§€ì˜ ì„œëª…ê³¼ ë¬´ê²°ì„± ê²€ì¦ì„ í†µí•´, ì´ë¯¸ì§€ê°€ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¶œì²˜ì—ì„œ ì™”ìœ¼ë©° ë³€ì¡°ë˜ì§€ ì•Šì•˜ìŒì„ ë³´ì¥í•˜ëŠ” ë³´ì•ˆ ê¸°ëŠ¥. 4ë‹¨ê³„ëŠ” DCTë¥¼ í™œì„±í™”í•˜ê³ , ì„œëª…ëœ ì´ë¯¸ì§€ë¥¼ pushí•œ í›„ ì„œëª…ë˜ì§€ ì•Šì€ ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šë„ë¡ í•˜ëŠ” ê³¼ì •.

### 1. Docker Content Trust í™œì„±í™”
- í™˜ê²½ ë³€ìˆ˜ ì„¤ì •:
```bash
export DOCKER_CONTENT_TRUST=1
```
- Notary ì„œë²„ ì‚¬ìš©:
Docker Content TrustëŠ” Notaryë¼ëŠ” ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œëª… ì •ë³´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤. ì´ë¯¸ì§€ push ì‹œ Notary ì„œë²„ì™€ í†µì‹ í•˜ì—¬ ì„œëª… ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ , pull ì‹œ ì´ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.

ì´ ì„¤ì •ì´ í™œì„±í™”ë˜ë©´, docker push, docker pull, docker run ë“±ì˜ ëª…ë ¹ì–´ëŠ” ì´ë¯¸ì§€ì˜ ì„œëª…ì„ ìë™ìœ¼ë¡œ í™•ì¸í•˜ê±°ë‚˜ ì„œëª…í•˜ë„ë¡ ë™ì‘í•©ë‹ˆë‹¤.

### 2. ì„œëª…ëœ ì´ë¯¸ì§€ í‘¸ì‹œ
ì´ë¯¸ì§€ ì„œëª… ë° Push:
DCT í™œì„±í™” ìƒíƒœì—ì„œ ì´ë¯¸ì§€ë¥¼ pushí•˜ë©´, Docker CLIê°€ í•´ë‹¹ ì´ë¯¸ì§€ì— ëŒ€í•´ ì„œëª… ì‘ì—…ì„ ì§„í–‰í•©ë‹ˆë‹¤.

```
docker push your-registry.example.com/your-image:tag
```
ì²˜ìŒ push ì‹œ, ì„œëª…ì„ ìœ„í•œ í‚¤ê°€ ì—†ë‹¤ë©´ Docker CLIê°€ ìƒì„±í•˜ë¼ê³  ìš”ì²­í•  ìˆ˜ ìˆìŒ.
ìƒì„±ëœ ì„œëª… ì •ë³´ëŠ” Notary ì„œë²„ì— ì €ì¥ë˜ì–´, ì´í›„ pullì´ë‚˜ run ì‹œ ì´ë¯¸ì§€ì˜ ë¬´ê²°ì„±ì„ í™•ì¸í•˜ëŠ” ë° ì‚¬ìš©ë¨.

ì„œëª…ëœ ì´ë¯¸ì§€ì˜ ì¥ì :
ì„œëª…ëœ ì´ë¯¸ì§€ëŠ” ì¸ì¦ëœ ì¶œì²˜ì—ì„œ ì™”ìœ¼ë©°, ë‚´ìš©ì´ ë³€ì¡°ë˜ì§€ ì•Šì•˜ìŒì„ ë³´ì¦. ì´ë¡œ ì¸í•´ ë°°í¬ íŒŒì´í”„ë¼ì¸ì—ì„œ ì´ë¯¸ì§€ ì‹ ë¢°ì„±ì„ ê°•í™”í•  ìˆ˜ ìˆìŒ.



### 3. notary docker-compose

docker hubë¥¼ ì‚¬ìš©í• ê²½ìš° notaryrê°€ ì•ˆì— ë‚´ì¥ë˜ìˆì–´ì„œ ì €ì ˆë¡œ ì²˜ë¦¬ê°€ ë˜ì§€ë§Œ, private registryê°™ì€ ê²½ìš°ëŠ” ì•ˆë¨.

íŠ¹íˆ ì“°ê³ ìˆëŠ” ê°€ìƒí™˜ê²½ì´ arm64ì¸ë° ì§€ì›ë˜ëŠ” ë²„ì „ë„ ì—†ì–´ì„œ dockerë¥¼ ì‚¬ìš©í•  ìˆ˜ ë°–ì— ì—†ì—ˆìŒ. ê³µì‹ í™ˆí˜ì´ì§€ì— ìˆëŠ” notary docker-composeë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ ì„¤ì¹˜. https://github.com/notaryproject/notary


### 3. notary docker-compose ì¸ì¦ì„œ ì¬ë°œê¸‰.
ë¬¸ì œëŠ” ì•ˆì— ë“¤ì–´ìˆëŠ” ì¸ì¦ì„œë“¤ì´ ë§Œë£Œë˜ì–´ì„œ ëª¨ë‘ ìƒˆë¡œ ë‹¤ì‹œ ë°œê¸‰.

```bash
Crt ìœ íš¨ê¸°ê°„.

for crt in *.crt; do Â  Â echo "Checking $crt"; Â  openssl x509 -in "$crt" -noout -dates; Â  echo "---------------------"; done

keyì™€ crt í•´ì‹œ ê²€ì‚¬.

for key in *.key; do Â  echo "Checking $key ..."; Â  openssl x509 -noout -modulus -in "${key/.key/.crt}" | openssl md5; Â  openssl rsa -noout -modulus -in "$key" | openssl md5; Â  echo "------------------------------------"; done

ì¸ì¦ì„œ ì œê±°

# Notary ì¸ì¦ì„œ ë° í‚¤ ì‚­ì œ

rm -rf fixtures/notary-server.crt fixtures/notary-server.key fixtures/notary-server.csr

rm -rf fixtures/notary-signer.crt fixtures/notary-signer.key fixtures/notary-signer.csr

rm -rf fixtures/notary-escrow.crt fixtures/notary-escrow.key fixtures/notary-escrow.csr

# Root CAë¥¼ ì œì™¸í•œ ëª¨ë“  ì¸ì¦ì„œ ì‚­ì œ

rm -rf fixtures/secure.example.com.crt fixtures/self-signed_docker.com-notary.crt

rm -rf fixtures/self-signed_secure.example.com.crt

(1) Notary ì„œë²„ ê°œì¸ í‚¤ ìƒì„±

openssl genrsa -out fixtures/notary-server.key 4096
(2) CSR (Certificate Signing Request) ìƒì„±

openssl req -new -key fixtures/notary-server.key -out fixtures/notary-server.csr -subj "/CN=notary-server"
(3) Root CAë¡œ Notary ì„œë²„ ì¸ì¦ì„œ ì„œëª…

openssl x509 -req -in fixtures/notary-server.csr -CA fixtures/root-ca.crt -CAkey fixtures/root-ca.key -CAcreateserial -out fixtures/notary-server.crt -days 365 -sha256

(1) Notary Signer í‚¤ & CSR ìƒì„±

openssl genrsa -out fixtures/notary-signer.key 4096
openssl req -new -key fixtures/notary-signer.key -out fixtures/notary-signer.csr -subj "/CN=notary-signer"
openssl x509 -req -in fixtures/notary-signer.csr -CA fixtures/root-ca.crt -CAkey fixtures/root-ca.key -CAcreateserial -out fixtures/notary-signer.crt -days 365 -sha256
(2) Notary Escrow í‚¤ & CSR ìƒì„±

openssl genrsa -out fixtures/notary-escrow.key 4096
openssl req -new -key fixtures/notary-escrow.key -out fixtures/notary-escrow.csr -subj "/CN=notary-escrow"
openssl x509 -req -in fixtures/notary-escrow.csr -CA fixtures/root-ca.crt -CAkey fixtures/root-ca.key -CAcreateserial -out fixtures/notary-escrow.crt -days 365 -sha256

```

![](https://velog.velcdn.com/images/luckyprice1103/post/99d0d808-d03d-4a1d-a249-b59ab194a9f5/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/21b18f4a-b56a-4bc1-bb99-331d0c666562/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/3d6be943-3ef3-4ccd-b2e8-eaf5b6b33812/image.png)

í‚¤ë¥¼ rootí‚¤ì— ë§ê²Œ í•˜ë‚˜í•˜ë‚˜ ë‹¤ ë§ì¶°ì£¼ê³  ìœ íš¨ì„±ë„ í™•ì¸ ì™„ë£Œ..!
![](https://velog.velcdn.com/images/luckyprice1103/post/2a5e9edb-6746-43c5-9055-e10c9053b097/image.png)


íŠ¹íˆ notary-server, notary-signer, db ì„¸ê°œì˜ ì»¨í…Œì´ë„ˆê°€ ëª¨ë‘ ê°ìì˜ ì»¨í…Œì´ë„ˆì—ì„œ ì ‘ì†ì´ ë˜ë„ë¡ í•´ì¤˜ì•¼í•˜ëŠ”ë° ì¸ì¦ì„œì™€ í‚¤ë¥¼ ëª¨ë‘ ìƒˆë¡œ ë§Œë“¤ì—ˆê¸°ë•Œë¬¸ì— ë§ì¶°ì£¼ëŠ”ê²ƒì´ ê¹Œë‹¤ë¡œì› ìŒ.



ìµœì¢…ì ìœ¼ë¡œ ëª¨ë‘ ìƒí™”ì‘ìš©ì´ ë˜ëŠ”ê²ƒì„ í™•ì¸ë°ë„ docker regisryì— push pullì´ ë„ì €íˆ ì•ˆë˜ì„œ í¬ê¸°. DCTëŠ” ê·¸ëƒ¥ docker hubë¥¼ ì‚¬ìš©í• ë•Œ ì“°ìâ€¦.!






## âœ… ë‹¨ê³„ 5: CI/CD ì—°ë™ ë° ìë™í™” í…ŒìŠ¤íŠ¸
â€¢ GitLab CI/CDì™€ Private Registry ì—°ë™
â€¢ .gitlab-ci.ymlì„ í™œìš©í•˜ì—¬ CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œ ìë™ìœ¼ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ

### 1. GitLab CI/CD í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ìƒˆ repositroy ìƒì„±.
![](https://velog.velcdn.com/images/luckyprice1103/post/b896f566-8a01-470e-8f11-445a2a92eeca/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/fef484ff-61bf-4e9e-acc6-7653950206d6/image.png)


GitLabì—ì„œ Private Registry ì¸ì¦ì„ ìœ„í•´ CI/CD í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •.

ğŸ“Œ GitLabì˜ Repository â†’ Settings â†’ CI/CD â†’ Variablesì—ì„œ ì¶”ê°€

ë³€ìˆ˜ëª…	ê°’ (ì˜ˆì‹œ)
REGISTRY	í•´ë‹¹ ì„œë²„ IP:5000
REGISTRY_USER	ì‚¬ìš©ìëª… (htpasswdì—ì„œ ì„¤ì •í•œ ê°’)
REGISTRY_PASSWORD	ë¹„ë°€ë²ˆí˜¸ (htpasswdì—ì„œ ì„¤ì •í•œ ê°’)

![](https://velog.velcdn.com/images/luckyprice1103/post/9e2183ff-7bb9-4d53-8d64-54169178b09e/image.png)

### 2. GitLab Runner ë“±ë¡

![](https://velog.velcdn.com/images/luckyprice1103/post/b9399128-cd87-4873-8b62-e06327f34526/image.png)

### 3 .gitlab-ci.yml ì‘ì„±
ì´ì œ GitLab CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œ Private Registryë¥¼ ìë™ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” .gitlab-ci.yml íŒŒì¼ì„ ì‘ì„±í•´ì•¼ í•¨.


- ë¡œì»¬ ë¨¸ì‹ ì— repository clone
![](https://velog.velcdn.com/images/luckyprice1103/post/6a055f30-37b0-4dab-9cd7-4e651cb432bf/image.png)

- ğŸ“Œ GitLab í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— .gitlab-ci.yml íŒŒì¼ ìƒì„±
```yaml
stages:
  - build
  - push

variables:
  IMAGE_NAME: "$REGISTRY/my-app"  # ì´ë¯¸ì§€ ì´ë¦„ ì§€ì • (my-appì€ í”„ë¡œì íŠ¸ëª…)
  DOCKER_DRIVER: overlay2  # GitLab Runnerì—ì„œ ë„ì»¤ ë¹Œë“œí•  ë•Œ í•„ìš”

before_script:
  - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin $REGISTRY  # Private Registry ë¡œê·¸ì¸

build:
  stage: build
  script:
    - docker build -t $IMAGE_NAME:$CI_COMMIT_REF_NAME .  # í˜„ì¬ ë¸Œëœì¹˜ëª…ìœ¼ë¡œ íƒœê·¸
  only:
    - main  # main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰

push:
  stage: push
  script:
    - docker push $IMAGE_NAME:$CI_COMMIT_REF_NAME  # ë¹Œë“œëœ ì´ë¯¸ì§€ í‘¸ì‹œ
  only:
    - main  # main ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰
```

![](https://velog.velcdn.com/images/luckyprice1103/post/00420198-6e58-4a4f-a8fb-1be44bb23f38/image.png)

### 4. GitLab CI/CD ì‹¤í–‰ ë° í™•ì¸
ì´ì œ GitLabì— ì½”ë“œ (.gitlab-ci.yml í¬í•¨)ë¥¼ í‘¸ì‹œí•˜ë©´ ìë™ìœ¼ë¡œ ë¹Œë“œ ë° í‘¸ì‹œê°€ ì§„í–‰ë¨.


```bash
git add .gitlab-ci.yml
git commit -m "Add GitLab CI/CD pipeline"
git push origin main
```

![](https://velog.velcdn.com/images/luckyprice1103/post/8f31379a-98a1-485c-a9c6-d2db7611756b/image.png)

âœ… error1
![](https://velog.velcdn.com/images/luckyprice1103/post/c74e9eea-e702-45e0-ac36-3ff4519f5dab/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/27810d08-975d-49e8-a289-f64ef7281f68/image.png)

í˜„ì¬ ë°œìƒí•œ docker: command not found -> GitLab Runnerë¥¼ docker executorë¡œ ë‹¤ì‹œ ì„¤ì •

ğŸ” í˜„ì¬ ë°œìƒí•œ ë¬¸ì œ (shell executorì˜ ë¬¸ì œì )
í˜„ì¬ GitLab Runnerê°€ shell executorë¡œ ë™ì‘ ì¤‘ â†’ ì‹¤í–‰ í™˜ê²½ì— ì§ì ‘ dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨.
í•˜ì§€ë§Œ í˜„ì¬ ì‹¤í–‰ í™˜ê²½ì—ì„œ dockerê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ (docker: command not found, docker: unrecognized service ì˜¤ë¥˜ ë°œìƒ).
ë”°ë¼ì„œ, Runnerë¥¼ docker executorë¡œ ë³€ê²½í•˜ë©´ GitLab CI/CD íŒŒì´í”„ë¼ì¸ì´ ë…ë¦½ì ì¸ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ, í˜¸ìŠ¤íŠ¸ í™˜ê²½ì˜ Docker ì„¤ì¹˜ ì—¬ë¶€ì— ì˜í–¥ì„ ë°›ì§€ ì•Šê²Œ ë¨.

âœ… error2
tls: failed to verify certifictae
![](https://velog.velcdn.com/images/luckyprice1103/post/7c10b302-3c2d-46c1-9996-87d794b295e6/image.png)

GitLab Runner ì»¨í…Œì´ë„ˆì—ì„œ ì¸ì¦ì„œë¥¼ ì‹ ë¢°í•˜ë„ë¡ ì„¤ì •í•´ì•¼ í•¨.

1ï¸âƒ£ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ì¸ì¦ì„œ ë³µì‚¬
í˜¸ìŠ¤íŠ¸ì—ì„œ GitLab Runner ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ì¸ì¦ì„œ ë³µì‚¬

```bash
docker cp /home/evan/cert/private_registry.crt 761c05739e65:/usr/local/share/ca-certificates/192.168.0.31.crt
```
ğŸ”¹ 2ï¸âƒ£ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì¸ì¦ì„œ ë“±ë¡
GitLab Runner ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì¸ì¦ì„œ ë“±ë¡


ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë“¤ì–´ê°„ í›„, ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰:
```bash
update-ca-certificates
```
ğŸ”¹ 3ï¸âƒ£ GitLab Runner ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
ì„¤ì •ì„ ì ìš©í•˜ê¸°ìœ„í•´ GitLab Runner ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹œì‘

```bash
docker restart 761c05739e65
```

ğŸ”¹ 4ï¸âƒ£ GitLab Runner ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ Private Registry ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸

```	bash
docker exec -it 761c05739e65 /bin/sh
echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin 192.168.0.31:5000
```
Login Succeeded -> ì„±ê³µ.





âœ… error3
ERROR: permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock

docker-compose.yml ìˆ˜ì • (GitLab Runner ì»¨í…Œì´ë„ˆë¥¼ privileged ëª¨ë“œë¡œ ì‹¤í–‰)

```bash
docker-compose down
docker-compose up -d

```

- ì•„ë¬´ë¦¬ ê¶Œí•œì„ ë°”ê¿”ì£¼ì–´ë„ ì»¨í…Œì´ë„ˆì— ë°˜ì˜ì´ ì•ˆë˜ì„œ ì¼ë‹¨ ì„ì‹œë¡œ sudo chmod 666 /var/run/docker.sock ë¡œ ë°”ê¿”ì£¼ì—ˆë‹¤.

![](https://velog.velcdn.com/images/luckyprice1103/post/1596bd2e-6464-4772-b087-8ef69a3082d3/image.png)


âœ… ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©´

GitLab CI/CD â†’ Pipelinesì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ë¹Œë“œë¥¼ í™•ì¸ ê°€ëŠ¥
Private Registry (localhost:5000)ì— ìƒˆë¡œ í‘¸ì‹œëœ ì´ë¯¸ì§€ í™•ì¸ ê°€ëŠ¥

```bash
curl -X GET https://localhost:5000/v2/_catalog
```



- ì„±ê³µ...!
![](https://velog.velcdn.com/images/luckyprice1103/post/936f661e-732b-4ced-bb52-ae29c865b8a4/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/bf0706f3-2a52-407e-acda-85c323a72c96/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/f89317cc-a434-4af0-80b4-18d29b3ab410/image.png)


ë‚´ê°€ gitlabì— pushë¥¼ í•˜ë©´ ì´ì œ ìë™ì ìœ¼ë¡œ gitrunnerì—ì„œ ê°ì§€ë¥¼ í•˜ê³  ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ì–´ì„œ ë‚˜ì˜ pirvate registryì— ë„£ì–´ì¤€ë‹¤...!
-dockerfile
```bash
# Nginx ê³µì‹ ì´ë¯¸ì§€ ì‚¬ìš©
FROM nginx:latest

# ë¹Œë“œ íƒ€ì„ì— í™˜ê²½ ë³€ìˆ˜ë¥¼ ë°›ì•„ì„œ index.html ìƒì„±
ARG COMMIT_COUNT=0
RUN echo "<h1>Hello, GitLab CI/CD-${COMMIT_COUNT}!</h1>" > /usr/share/nginx/html/index.html

# Nginx ì‹¤í–‰
CMD ["nginx", "-g", "daemon off;"]

```

- ìµœì¢… .gitlab-ci.yml íŒŒì¼.
ì»¤ë°‹ íšŸìˆ˜ì— ë”°ë¼ì„œ ìƒˆë¡œìš´ ì›¹í˜ì´ì§€ë¥¼ ë§Œë“œëŠ” ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.

``` bash
  GNU nano 4.8                                                           .gitlab-ci.yml                                                                      
stages:
  - build
  - push


variables:
  IMAGE_NAME: "$REGISTRY/my-app"
  DOCKER_DRIVER: overlay2


before_script:
  - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin $REGISTRY


build:
  stage: build
  script:
    - COMMIT_COUNT=$(git rev-list --count HEAD)
    - docker build --build-arg COMMIT_COUNT=$COMMIT_COUNT -t $IMAGE_NAME:$CI_COMMIT_REF_NAME .
  only:
    - main


push:
  stage: push
  script:
    - docker push $IMAGE_NAME:$CI_COMMIT_REF_NAME
  only:
    - main

```


ì´ì œ private registryì—ì„œ íŒŒì¼ì„ ë°›ì•„ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•´ë³´ì.



```bash
docker run -d --name my-nginx -p 8080:80 192.168.0.31:5000/my-app:main
```

![](https://velog.velcdn.com/images/luckyprice1103/post/9efe051c-988c-4944-928b-90053fb51cf7/image.png)

### 5. ìµœì¢… ê³¼ì œ

- dockerfile
```bash
# Nginx ê³µì‹ ì´ë¯¸ì§€ ì‚¬ìš©
FROM nginx:latest

# Git ì»¤ë°‹ ìˆ˜ & message.txt ë‚´ìš©ì„ ë°›ì•„ì„œ index.html ìƒì„±
ARG COMMIT_COUNT=0
COPY message.txt /tmp/message.txt
RUN echo "<h1>$(cat /tmp/message.txt) - Version: ${COMMIT_COUNT}</h1>" > /usr/share/nginx/html/index.html

# Nginx ì‹¤í–‰
CMD ["nginx", "-g", "daemon off;"]
```
- .gitlab-ci.yml 

```bash
stages:
  - build
  - push

variables:
  IMAGE_NAME: "$REGISTRY/my-app"
  DOCKER_DRIVER: overlay2

before_script:
  - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin $REGISTRY

build:
  stage: build
  script:
    - COMMIT_COUNT=$(git rev-list --count HEAD)
    - docker build --build-arg COMMIT_COUNT=$COMMIT_COUNT -t $IMAGE_NAME:$CI_COMMIT_REF_NAME .
  only:
    - main

push:
  stage: push
  script:
    - docker push $IMAGE_NAME:$CI_COMMIT_REF_NAME
  only:
    - main

```

- variables(htpasswd)
![](https://velog.velcdn.com/images/luckyprice1103/post/8359867c-71bf-48ca-9066-928704923e65/image.png)



- message.txt
![](https://velog.velcdn.com/images/luckyprice1103/post/8dda73ab-cfe4-49ce-888e-314644d3e254/image.png)

![](https://velog.velcdn.com/images/luckyprice1103/post/68e65a2d-f228-4d5f-b146-5e31ecfed97f/image.png)



> -> message.txt ìˆ˜ì •.

![](https://velog.velcdn.com/images/luckyprice1103/post/6ac32271-5c52-48de-aa24-107ba3c649fb/image.png)

> -> gitlabì— push

![](https://velog.velcdn.com/images/luckyprice1103/post/dd8c22d0-6fe2-4acc-8d7a-577d95b362ac/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/5c5c62cd-c655-4f19-873b-f7a2bd5c3062/image.png)

> -> íŒŒì´í”„ë¼ì¸ ì„±ê³µ.
pushë°›ìœ¼ë©´ gitlab-runnerê°€ ê°ì§€-> ë„ì»¤ ì´ë¯¸ì§€ ìƒì„± -> private registryë¡œ push

![](https://velog.velcdn.com/images/luckyprice1103/post/adc66db4-73f5-4b7f-b814-dca2e89a6d8b/image.png)



> -> private registryì—ì„œ ë°›ì€ ì´ë¯¸ì§€ pull

![](https://velog.velcdn.com/images/luckyprice1103/post/78516fdf-83ad-4a2f-9e9f-ca768d3e6bfe/image.png)![](https://velog.velcdn.com/images/luckyprice1103/post/e08753ad-1335-4294-9d8c-169c97be34cf/image.png)

> -> ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œí›„ ë°©ê¸ˆ ë°›ì€ ìƒˆë¡œìš´ ì´ë¯¸ì§€ run

![](https://velog.velcdn.com/images/luckyprice1103/post/d33e7aac-f231-47c5-9c6d-ed91de2265b0/image.png)
messageë¥¼ ìˆ˜ì •í•œëŒ€ë¡œ ê²°ê³¼ë¬¼ì´ ì˜ë‚˜ì˜´....!


## âœ… í›„ê¸° 
Docker Content Trustë¥¼ ì‹¤íŒ¨í•˜ê¸°ë„ í–ˆê³  ì‹œê°„ì„ ë„ˆë¬´ ë§ì´ ì¨ì„œ cdê¹Œì§€ëŠ” í•˜ì§€ ëª»í•œê²ƒê°™ë‹¤. ìë™ì ìœ¼ë¡œ ë°°í¬ê°€ ë˜ì•¼í•˜ëŠ”ë° commit í›„ gitlab runnerë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ private registryì— ë„£ëŠ”ê²ƒê¹Œì§€ë§Œ ìë™í™”ê³ , ì‚¬ì‹¤ìƒ ë’¤ì—ëŠ” ì§ì ‘ ë‹¤ìš´ë°›ì•„ì„œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ì‹œì¼œì•¼ ë™ì‘ì´ ëœë‹¤.
ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ë°°ìš°ë©´ ì´ê²ƒì„ ì´ìš©í•´ì„œ ë” ê·¸ëŸ´ì‹¸í•œ ci/cdí™˜ê²½ì„ ë§Œë“¤ê³  ì‹¶ë‹¤.